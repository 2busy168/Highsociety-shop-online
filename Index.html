<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="format-detection" content="telephone=no, email=no, address=no, date=no" />
  <title>H!GH$OC!‚Ç¨T¬• - Cannabis E-commerce</title>

  <!-- Tailwind + Font + LIFF -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
    a{ color:inherit; text-decoration:none; } a:focus,a:hover{ text-decoration:none; }
    img,svg{ max-width:100%; height:auto; display:block; }

    /* Safe area */
    :root{ --safe-t:env(safe-area-inset-top); --safe-r:env(safe-area-inset-right);
           --safe-b:env(safe-area-inset-bottom); --safe-l:env(safe-area-inset-left); }
    body{ font-family:'Kanit',sans-serif; }
    header{ padding-top:var(--safe-t); }
    header,.gradient-bg,main,footer{ padding-left:max(1rem,var(--safe-l)); padding-right:max(1rem,var(--safe-r)); }

    /* Layout safety */
    html,body{ width:100%!important; max-width:100%!important; overflow-x:hidden!important; }

    .gradient-bg{ background:linear-gradient(135deg,#065f46 0%,#10b981 100%); }
    .card-hover{ transition:all .3s ease; } .card-hover:hover{ transform:translateY(-5px); box-shadow:0 20px 25px -5px rgba(0,0,0,.1); }
    .feeling-btn{ transition:all .2s ease; } .feeling-btn:hover{ background:#d1fae5; transform:scale(1.05); }
    .feeling-btn.active{ background:#047857; color:#fff; transform:scale(1.1); box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05); }
    .tag{ padding:.25rem .75rem; border-radius:9999px; font-size:.75rem; font-weight:500; white-space:nowrap; }
    .card-img{ aspect-ratio:4/3; width:100%; height:auto; object-fit:cover; border-radius:.5rem; }
    #loading-spinner{ display:none; }

    /* Header: ‡πÇ‡∏•‡πÇ‡∏Å‡πâ + ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ + 3 ‡∏Ç‡∏µ‡∏î */
    #header-actions{ display:flex; align-items:center; gap:1rem; flex-wrap:nowrap; }
    #header-actions > *{ flex-shrink:0; }

    /* Drawer */
    #mobile-drawer.hidden{ display:none; }
    #mobile-drawer{ z-index:9999; }
    #mobile-drawer-panel{ color:#111; }
    #mobile-drawer-panel .drawer-link{ color:#111!important; font-size:16px; }

    /* Modals on top */
    #cart-modal-container,#modal-container,#add-modal-container{ z-index:10000; }
  </style>

  <script>
    // width fix for LINE WebView
    (function(){ function setVW(){ document.documentElement.style.setProperty('--vwpx', window.innerWidth+'px'); }
      setVW(); window.addEventListener('resize', setVW); })();
  </script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Header -->
  <header class="gradient-bg text-white shadow-lg p-4 sticky top-0 z-50">
    <!-- Drawer -->
    <div id="mobile-drawer" class="fixed inset-0 hidden">
      <div id="mobile-drawer-backdrop" class="absolute inset-0 bg-black bg-opacity-50"></div>
      <aside id="mobile-drawer-panel" class="absolute inset-y-0 right-0 w-5/6 max-w-xs bg-white shadow-2xl transform translate-x-full transition-transform duration-200 ease-out">
        <div class="p-4 flex items-center justify-between border-b">
          <span class="text-lg font-bold">‡πÄ‡∏°‡∏ô‡∏π</span>
          <button id="mobile-drawer-close" class="p-2 rounded hover:bg-gray-100" aria-label="‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π">‚úï</button>
        </div>
        <nav class="divide-y divide-gray-100">
          <button class="drawer-link w-full text-left px-4 py-3" data-action="go" data-target="strains">‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</button>
          <button class="drawer-link w-full text-left px-4 py-3" data-action="go" data-target="equipments">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
          <button class="drawer-link w-full text-left px-4 py-3" data-action="go" data-target="promotions">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</button>
          <button class="drawer-link w-full text-left px-4 py-3" data-action="order-history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
          <button class="drawer-link w-full text-left px-4 py-3" data-action="line-login">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE</button>
          <a class="drawer-link w-full text-left px-4 py-3 block" href="admin.html">Admin</a>
        </nav>
      </aside>
    </div>

    <div class="container mx-auto flex justify-between items-center px-4">
      <div class="text-2xl font-bold flex items-center cursor-pointer" onclick="window.location.reload();">
        <span class="mr-2">üå±</span>H!GH$OC!‚Ç¨T¬•
      </div>
      <div id="header-actions" class="flex items-center space-x-4">
        <button id="line-login-btn" class="bg-white text-green-700 font-semibold py-1.5 px-3 rounded-full text-sm hover:bg-gray-100">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE</button>
        <span class="relative cursor-pointer" id="cart-icon-container" aria-label="‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center">0</span>
        </span>
        <button id="mobile-menu-btn" class="ml-1" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Loading -->
  <div id="loading-spinner" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-green-500"></div>
  </div>

  <!-- Hero -->
  <section id="hero-section" class="gradient-bg text-white py-10 md:py-20 text-center px-4">
    <h1 id="hero-title" class="text-3xl md:text-5xl font-bold mb-3 md:mb-4">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì</h1>
    <p id="hero-subtitle" class="text-base md:text-xl font-light">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì</p>
  </section>

  <!-- Feelings -->
  <section id="feelings-section" class="py-6 md:py-10 bg-white shadow-lg -mt-8 md:-mt-16 mx-auto rounded-xl max-w-7xl relative z-20">
    <h2 class="text-center text-xl md:text-2xl font-semibold mb-5 px-4">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô?</h2>
    <div id="feelings-container" class="flex flex-wrap justify-center gap-2 md:gap-4 px-4"></div>
  </section>

  <!-- Main -->
  <main class="container mx-auto py-8 md:py-12 px-4">
    <h2 id="main-content-title" class="text-2xl md:3xl font-bold text-center mb-6">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
    <div id="main-content-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-8 px-4">
    <div class="container mx-auto text-center">
      <h3 class="text-xl font-bold mb-2">H!GH$OC!‚Ç¨T¬•</h3>
      <p class="text-sm text-gray-400">‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏î‡∏µ ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏° ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£</p>
      <p class="text-xs text-gray-500 mt-4">‚ö†Ô∏è ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏ 20 ‡∏õ‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
    </div>
  </footer>

  <!-- Simple modal -->
  <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full mx-4">
      <h3 id="modal-title" class="text-xl font-bold mb-4 text-center"></h3>
      <p id="modal-message" class="text-gray-700 text-center mb-6"></p>
      <div class="flex justify-center">
        <button id="modal-ok-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
    </div>
  </div>

  <!-- Cart modal -->
  <div id="cart-modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full mx-4 overflow-y-auto max-h-[90vh]">
      <h3 class="text-2xl font-bold mb-4 text-center">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
      <div id="cart-items-list" class="space-y-4 mb-6"></div>
      <div id="cart-summary" class="border-t pt-4 text-right">
        <span class="text-lg font-bold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span id="cart-total-price">‡∏ø0</span></span>
      </div>
      <div id="order-form-container" class="mt-6">
        <h4 class="text-xl font-bold mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h4>
        <div class="mb-4">
          <label for="customerName" class="block text-gray-700 font-semibold mb-2">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <input type="text" id="customerName" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        <div class="mb-4">
          <label for="customerEmail" class="block text-gray-700 font-semibold mb-2">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
          <input type="text" id="customerEmail" placeholder="‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
      </div>
      <div class="relative mt-6">
        <button id="checkout-button" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all duration-300 transform hover:scale-105">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
        <div id="checkout-loading-indicator" class="absolute inset-0 flex items-center justify-center bg-green-600 bg-opacity-75 rounded-xl hidden">
          <div class="w-8 h-8 border-4 border-white border-solid rounded-full animate-spin border-t-transparent"></div>
        </div>
      </div>
      <p id="checkout-status-message" class="text-center mt-4 text-sm text-gray-600"></p>
      <div class="flex justify-end mt-4">
        <button id="cart-close-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition-colors">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- ADD-TO-CART (Pack + Qty) modal -->
  <div id="add-modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
      <h3 class="text-xl font-bold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Ñ & ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h3>
      <p id="add-modal-name" class="text-sm text-gray-600 mb-4"></p>

      <div id="pack-section" class="mb-4">
        <h4 class="font-semibold mb-2">‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏û‡πá‡∏Ñ</h4>
        <div id="pack-options" class="grid grid-cols-2 gap-2"></div>
      </div>

      <div class="mb-4">
        <h4 class="font-semibold mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h4>
        <div class="flex items-center gap-2">
          <button id="qty-dec" class="px-3 py-2 border rounded">-</button>
          <input id="qty-input" type="number" min="1" value="1" class="w-20 text-center border rounded py-2">
          <button id="qty-inc" class="px-3 py-2 border rounded">+</button>
          <span id="stock-hint" class="text-xs text-gray-500 ml-2"></span>
        </div>
      </div>

      <div class="flex items-center justify-between mb-4">
        <div class="text-sm text-gray-600">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢: <span id="unit-price" class="font-semibold text-gray-900">‡∏ø0</span></div>
        <div class="text-sm text-gray-600">‡∏£‡∏ß‡∏°: <span id="total-price" class="font-semibold text-gray-900">‡∏ø0</span></div>
      </div>

      <div class="flex gap-3 justify-end">
        <button id="add-cancel" class="px-4 py-2 rounded bg-gray-200 text-gray-800">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="add-confirm" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
      </div>
    </div>
  </div>

  <script>
  /* ===== CONFIG ===== */
  const APP_URL = "https://script.google.com/macros/s/AKfycbzis9Isw6XXUsi7k8MQmI4rJI8gnFnPS0VIDpuvsgw88dC8SwQ4VOHKK5TfeQMDKgLotA/exec";
  const LIFF_ID = "2007862659-qJLl52wb";
  const LINE_OA_ID = "@761qogmt";
  const oaIdNoAt = () => (LINE_OA_ID||'').replace(/^@/,'');

  const feelingToStrain = {
    "‡∏î‡∏π‡∏´‡∏ô‡∏±‡∏á":"Hybrid","‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á":"Hybrid","‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°":"Hybrid",
    "‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î":"Indica","‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤":"Indica","‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö":"Indica",
    "‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ò‡∏¥":"Sativa","‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÉ‡∏´‡∏°‡πà":"Sativa","‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ":"Sativa"
  };
  const strainDescriptions = {
    "Indica": { icon:"üò¥", tagColor:"bg-purple-100 text-purple-800" },
    "Sativa": { icon:"‚ö°", tagColor:"bg-yellow-100 text-yellow-800" },
    "Hybrid": { icon:"üåø", tagColor:"bg-green-100 text-green-800" }
  };
  const equipmentDescription = { icon:"‚öôÔ∏è", tagColor:"bg-gray-100 text-gray-800" };

  let strains=[], equipments=[], promotions=[], cart=[], currentView="strains", activeFeeling=null;

  // ===== Helpers =====
  const el = id => document.getElementById(id);
  function showLoading(){ el('loading-spinner').style.display='flex'; }
  function hideLoading(){ el('loading-spinner').style.display='none'; }
  function showModal(id,title='',message=''){ const m=el(id); if(id==='modal-container'){ el('modal-title').textContent=title; el('modal-message').textContent=message; } m.classList.remove('hidden'); }
  function hideModal(id){ el(id).classList.add('hidden'); }
  function isStrainProduct(p){ return ['Indica','Sativa','Hybrid'].includes(String(p.type||'').trim()); }

  async function apiGet(params){ const url=APP_URL+'?'+new URLSearchParams(params).toString(); const res=await fetch(url,{cache:'no-store'}); return res.json(); }
  async function apiPost(payload){ const res=await fetch(APP_URL,{ method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body:JSON.stringify(payload)}); if(!res.ok) throw new Error('HTTP '+res.status); return res.json(); }

  function updateHeroSection(title,subtitle){ el('hero-title').textContent=title; el('hero-subtitle').textContent=subtitle; }

  function toggleView(view){
    currentView=view;
    if(view==='strains'){
      el('main-content-title').textContent='‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
      el('feelings-section').style.display='block';
      updateHeroSection('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì','‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì');
      filterProductsByFeeling(activeFeeling);
    }else if(view==='equipments'){
      el('main-content-title').textContent='‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
      el('feelings-section').style.display='none';
      updateHeroSection('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πà','‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
      renderContentCards(equipments,'equipments');
    }else if(view==='promotions'){
      el('main-content-title').textContent='‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©';
      el('feelings-section').style.display='none';
      updateHeroSection('‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°','‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏î‡∏µ‡πÜ ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà');
      renderContentCards(promotions,'promotions');
    }
  }

  function createFeelingButtons(){
    const wrap=el('feelings-container'); wrap.innerHTML='';
    Object.keys(feelingToStrain).forEach(feeling=>{
      const st=feelingToStrain[feeling]; const info=strainDescriptions[st];
      const b=document.createElement('button');
      b.className='feeling-btn bg-green-50 text-gray-800 font-semibold py-2 px-4 rounded-full flex items-center shadow-sm hover:shadow-md';
      b.dataset.feeling=feeling; b.innerHTML='<span class="mr-2 text-lg">'+info.icon+'</span>'+feeling;
      b.addEventListener('click',handleFeelingClick); wrap.appendChild(b);
    });
  }
  function handleFeelingClick(e){
    document.querySelectorAll('.feeling-btn').forEach(b=>b.classList.remove('active'));
    const feeling=e.currentTarget.dataset.feeling;
    if(activeFeeling===feeling) activeFeeling=null; else { activeFeeling=feeling; e.currentTarget.classList.add('active'); }
    filterProductsByFeeling(activeFeeling);
  }
  function filterProductsByFeeling(feeling){
    let filtered=strains||[];
    if(feeling){
      const required=feelingToStrain[feeling];
      filtered=strains.filter(s=>String(s.type)===required);
      const info=strainDescriptions[required];
      el('main-content-title').innerHTML=info.icon+' ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <span class="text-green-600">"'+feeling+'"</span>';
    }else el('main-content-title').textContent='‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    renderContentCards(filtered,'strains');
  }

  function renderContentCards(items,type){
    const list = el('main-content-list'); list.innerHTML='';
    if(!items||!items.length){ list.innerHTML='<p class="col-span-full text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ</p>'; return; }
    items.forEach(it=>{ const card=(type==='promotions')?createPromotionCard(it):createProductCard(it); if(card) list.appendChild(card); });
  }

  // ===== ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°) =====
  function createProductCard(p){
    const info = isStrainProduct(p)?strainDescriptions[p.type]:equipmentDescription;
    const out  = Number(p.stock||0)<=0;

    const aroma   = (p.aroma||'').toString().trim();
    const effects = (p.effects||'').toString().trim();

    // THC
    let thc = '';
    if (p.thc_percent!=null && p.thc_percent!=='') thc = '~'+Number(p.thc_percent).toFixed(1)+'%';
    else if (p.thc!=null && p.thc!=='') thc = String(p.thc);

    // Indica/Sativa %
    const n=v=> (v===''||v==null||isNaN(Number(v)))?null:Number(v);
    let indica=n(p.indica_percent), sativa=n(p.sativa_percent);
    if(indica!=null && sativa==null) sativa=Math.max(0,100-indica);
    if(sativa!=null && indica==null) indica=Math.max(0,100-sativa);

    // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á)
    const p1  = p.price_1g   ?? p.price1g   ?? '';
    const p35 = p.price_3_5g ?? p.price3_5g ?? '';
    const p5  = p.price_5g   ?? p.price5g   ?? '';
    const p10 = p.price_10g  ?? p.price10g  ?? '';
    const priceParts=[];
    if(p1)  priceParts.push(`1g ‡∏ø${p1}`);
    if(p35) priceParts.push(`3.5g ‡∏ø${p35}`);
    if(p5)  priceParts.push(`5g ‡∏ø${p5}`);
    if(p10) priceParts.push(`10g ‡∏ø${p10}`);

    const line1=[aroma?`‡∏Å‡∏•‡∏¥‡πà‡∏ô/‡∏£‡∏™: <span class="font-medium">${aroma}</span>`:'',effects?`‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå: <span class="font-medium">${effects}</span>`:''].filter(Boolean).join(' | ');
    const line2=[thc?`THC ${thc}`:'',(indica!=null && sativa!=null)?`Indica ${indica}% / Sativa ${sativa}%`:'' ].filter(Boolean).join(' | ');
    const line3=priceParts.length?('‡∏£‡∏≤‡∏Ñ‡∏≤: '+priceParts.join(' | ')):''; // ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

    const stock = out ? '<span class="text-red-500 font-semibold">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</span>' : '<span class="text-gray-500">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ '+p.stock+' ‡∏ä‡∏¥‡πâ‡∏ô</span>';
    const btn = out
      ? '<button class="bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg cursor-not-allowed" disabled>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</button>'
      : '<button class="add-to-cart-btn bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors" data-id="'+p.id+'" data-type="'+(isStrainProduct(p)?'strains':'equipments')+'">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>';

    const d=document.createElement('div');
    d.className='bg-white rounded-lg shadow-md p-6 card-hover flex flex-col justify-between';
    d.innerHTML=''
      +'<div>'
      +  '<img src="'+(p.imageUrl||'')+'" onerror="this.onerror=null;this.src=\'https://placehold.co/400x300/cccccc/333333?text=Image+Not+Found\';" alt="'+(p.name||'')+'" class="rounded-md mb-4 object-cover w-full h-48">'
      +  '<div class="flex justify-between items-center mb-2">'
      +    '<h3 class="text-xl font-bold text-green-700">'+(p.name||'-')+'</h3>'
      +    '<div class="tag '+info.tagColor+' flex items-center"><span class="mr-1">'+info.icon+'</span><span>'+(p.type||'')+'</span></div>'
      +  '</div>'
      +  (p.description?'<p class="text-sm text-gray-500 mb-3">'+p.description+'</p>':'')
      +  (line1?'<p class="text-sm text-gray-700">'+line1+'</p>':'')
      +  (line2?'<p class="text-sm text-gray-700">'+line2+'</p>':'')
      +  (line3?'<p class="text-sm font-semibold text-gray-900 mt-1">'+line3+'</p>':'')
      +'</div>'
      +'<div class="flex justify-between items-end mt-4">'
      +  '<div><span class="text-2xl font-bold text-gray-900">‡∏ø'+Number(p.price||0)+'</span> '+stock+'</div>'
      +  btn
      +'</div>';
    return d;
  }

  function createPromotionCard(pm){
    const d=document.createElement('div');
    d.className='bg-white rounded-lg shadow-md p-6 card-hover flex flex-col justify-between';
    const end=pm.endDate?new Date(pm.endDate):null;
    d.innerHTML=''
      +'<div>'
      +  '<img src="'+(pm.imageUrl||'')+'" onerror="this.onerror=null;this.src=\'https://placehold.co/400x300/cccccc/333333?text=Image+Not+Found\';" alt="'+(pm.title||'')+'" class="rounded-md mb-4 object-cover w-full h-48">'
      +  '<h3 class="text-xl font-bold text-green-700 mb-2">'+(pm.title||'-')+'</h3>'
      +  '<p class="text-sm text-gray-500 mb-4">'+(pm.description||'')+'</p>'
      +'</div>'
      +'<div class="flex items-center space-x-2 text-sm text-gray-600 mt-4">'
      +  (pm.discount?'<span class="tag bg-red-100 text-red-800 font-semibold">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î '+pm.discount+'%</span>':'')
      +  (end?'<span class="tag bg-gray-100 text-gray-800">‡∏ñ‡∏∂‡∏á '+end.toLocaleDateString('th-TH')+'</span>':'')
      +'</div>';
    return d;
  }

  function getProductById(id,type){ const pool=(type==='strains')?strains:equipments; return pool.find(x=>String(x.id)===String(id)); }

  // ===== ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ cart ‡πÄ‡∏î‡∏¥‡∏° + ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÅ‡∏û‡πá‡∏Ñ) =====
  function getPackOptions(p){
    const ops = [];
    const map = [
      { key:'1g',   label:'1g',   val: p.price_1g   ?? p.price1g   },
      { key:'3.5g', label:'3.5g', val: p.price_3_5g ?? p.price3_5g },
      { key:'5g',   label:'5g',   val: p.price_5g   ?? p.price5g   },
      { key:'10g',  label:'10g',  val: p.price_10g  ?? p.price10g  },
    ];
    map.forEach(m=>{
      const num = (m.val!=='' && m.val!=null) ? Number(m.val) : NaN;
      if (!isNaN(num) && num>0) ops.push({ key:m.key, label:m.label, price:num });
    });
    return ops;
  }

  // ‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô" ‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏±‡∏•
  function addToCart(id, type, qty = 1, packKey = null, packLabel = null, packPrice = null){
    const p = getProductById(id, type);
    if(!p) return;

    const maxStock = Number(p.stock||0);
    if (maxStock <= 0){ showModal('modal-container','‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î','"'+(p.name||'-')+'" ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å'); return; }

    // ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏û‡πá‡∏Ñ
    let unitPrice = null, unitLabel = null;
    if (packLabel!=null && packPrice!=null){
      unitLabel = String(packLabel);
      unitPrice = Number(packPrice)||0;
    } else if (packKey!=null){
      const found = getPackOptions(p).find(o=>o.key===packKey);
      if (found){ unitLabel=found.label; unitPrice=found.price; }
    }
    if (unitPrice==null){ unitPrice = Number(p.price||0); } // fallback
    if (!unitLabel && packKey){ unitLabel = String(packKey); }

    const key = type + ':' + p.id + (unitLabel? ':'+unitLabel:'');
    const ex  = cart.find(i => i.key===key);

    qty = Math.max(1, Number(qty||1));
    if (ex){
      if (ex.quantity + qty > maxStock){
        const left = Math.max(0, maxStock - ex.quantity);
        showModal('modal-container','‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠','"'+(p.name||'-')+'" ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ '+ left +' ‡∏ä‡∏¥‡πâ‡∏ô');
        return;
      }
      ex.quantity += qty;
    } else {
      if (qty > maxStock){
        showModal('modal-container','‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠','"'+(p.name||'-')+'" ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ '+ maxStock +' ‡∏ä‡∏¥‡πâ‡∏ô');
        return;
      }
      cart.push({
        key, type, id:p.id,
        name: p.name + (unitLabel? ' ('+unitLabel+')':''),
        price: unitPrice,
        quantity: qty,
        imageUrl: p.imageUrl || ''
      });
    }
    updateCartUI();
    showModal('modal-container','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡πÄ‡∏û‡∏¥‡πà‡∏° "'+(p.name||'-')+(unitLabel? ' ('+unitLabel+')':'')+'" x'+qty+' ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
  }

  function updateCartUI(){ el('cart-count').textContent = cart.reduce((t,i)=>t+i.quantity,0); renderCartItems(); }
  function renderCartItems(){
    const list=el('cart-items-list'); const btn=el('checkout-button'); list.innerHTML=''; let total=0;
    if(!cart.length){ list.innerHTML='<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>'; btn.disabled=true; btn.classList.add('bg-gray-400','cursor-not-allowed'); btn.classList.remove('bg-green-600','hover:bg-green-700'); }
    else{
      cart.forEach(i=>{ const line=i.price*i.quantity; total+=line;
        list.innerHTML+= '<div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">'
          +'<div class="flex items-center space-x-4">'
          +  '<img src="'+i.imageUrl+'" alt="'+i.name+'" class="w-16 h-16 object-cover rounded-md">'
          +  '<div><h4 class="font-semibold">'+i.name+'</h4><p class="text-sm text-gray-500">‡∏ø'+i.price+' x '+i.quantity+'</p></div>'
          +'</div>'
          +'<div class="flex items-center gap-2">'
          +  '<button class="px-2 py-1 border rounded" data-qty="-1" data-key="'+i.key+'">-</button>'
          +  '<span class="font-bold">‡∏ø'+line+'</span>'
          +  '<button class="px-2 py-1 border rounded" data-qty="+1" data-key="'+i.key+'">+</button>'
          +  '<button class="px-2 py-1 border rounded text-red-600" data-remove="1" data-key="'+i.key+'">‡∏•‡∏ö</button>'
          +'</div></div>';
      });
      btn.disabled=false; btn.classList.remove('bg-gray-400','cursor-not-allowed'); btn.classList.add('bg-green-600','hover:bg-green-700');
    }
    el('cart-total-price').textContent='‡∏ø'+total;
  }
  function changeQty(key,delta){ const it=cart.find(i=>i.key===key); if(!it) return; it.quantity=Math.max(1,it.quantity+delta); updateCartUI(); }
  function removeItem(key){ cart=cart.filter(i=>i.key!==key); updateCartUI(); }

  // ===== ‡πÇ‡∏°‡∏î‡∏±‡∏•‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Ñ + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô =====
  const addCtx = { id:null, type:null, stock:0, unitPrice:0, unitLabel:null };
  function openAddModal(id,type){
    const p = getProductById(id,type); if(!p) return;

    addCtx.id = id;
    addCtx.type = type;
    addCtx.stock = Number(p.stock||0) || 0;

    el('add-modal-name').textContent = (p.name||'-');
    el('qty-input').value = 1;
    el('stock-hint').textContent = addCtx.stock ? `(‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${addCtx.stock})` : '';

    const ops = getPackOptions(p);
    const packSection = el('pack-section');
    const packWrap = el('pack-options');
    packWrap.innerHTML = '';

    if (ops.length){
      packSection.style.display = '';
      ops.forEach((o,idx)=>{
        const idr = `pack-${o.key}-${id}`;
        const item = document.createElement('label');
        item.className = 'border rounded px-3 py-2 flex items-center gap-2 cursor-pointer';
        item.innerHTML = `
          <input type="radio" name="pack" id="${idr}" value="${o.key}" ${idx===0?'checked':''}>
          <span class="flex-1">${o.label}</span>
          <span class="font-semibold">‡∏ø${o.price}</span>
        `;
        packWrap.appendChild(item);
      });
      // set default
      addCtx.unitLabel = ops[0].label;
      addCtx.unitPrice = ops[0].price;
    } else {
      packSection.style.display = 'none';
      addCtx.unitLabel = null;
      addCtx.unitPrice = Number(p.price||0) || 0;
    }

    // update prices UI
    el('unit-price').textContent = '‡∏ø'+addCtx.unitPrice;
    el('total-price').textContent = '‡∏ø'+(addCtx.unitPrice * Number(el('qty-input').value||1));

    showModal('add-modal-container');

    // bind change pack
    packWrap.addEventListener('change', (e)=>{
      if (e.target && e.target.name==='pack'){
        const key = e.target.value;
        const found = ops.find(x=>x.key===key);
        if(found){
          addCtx.unitLabel = found.label;
          addCtx.unitPrice = found.price;
          el('unit-price').textContent = '‡∏ø'+addCtx.unitPrice;
          el('total-price').textContent = '‡∏ø'+(addCtx.unitPrice * Number(el('qty-input').value||1));
        }
      }
    }, { once:false });
  }

  // ===== LIFF =====
  function getLineUser(){ try{ return JSON.parse(localStorage.getItem('lineUser')||'{}'); }catch{ return {}; } }
  function paintUser(u){ if(u && u.userId){ el('line-login-btn').textContent = '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, '+(u.displayName||'‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô'); } }
  async function initLiff(){ try{ await liff.init({ liffId: LIFF_ID }); window.__liffInited=true; if(!liff.isLoggedIn()) return; const p=await liff.getProfile(); const u={ userId:p.userId, displayName:p.displayName, pictureUrl:p.pictureUrl }; localStorage.setItem('lineUser',JSON.stringify(u)); paintUser(u);}catch(e){ console.warn('LIFF init error',e); } }
  function maybeInitLiff(){ if(!LIFF_ID) return; initLiff(); }
  async function handleLineLogin(){
    try{ if(!LIFF_ID){ location.href='https://line.me/R/ti/p/@'+oaIdNoAt(); return; }
      if(!window.__liffInited){ await liff.init({ liffId: LIFF_ID }); window.__liffInited=true; }
      if(!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return; }
      const p=await liff.getProfile(); const user={ userId:p.userId, displayName:p.displayName, pictureUrl:p.pictureUrl };
      localStorage.setItem('lineUser',JSON.stringify(user)); paintUser(user); alert('‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }catch(e){ alert('‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô LINE ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
  }

  async function sendOrderToOA(text){
    if (!window.__liffInited) { await liff.init({ liffId: LIFF_ID }); window.__liffInited=true; }
    const inClient = liff.isInClient?.(); const ctx = liff.getContext?.() || { type:'none' };
    if(inClient && (ctx.type==='utou'||ctx.type==='room'||ctx.type==='group')){ await liff.sendMessages([{type:'text',text}]); return true; }
    if(inClient && liff.shareTargetPicker){ const res=await liff.shareTargetPicker([{type:'text',text}]); if(res) return true; }
    try{ await navigator.clipboard.writeText(text); }catch(_){}
    location.href='https://line.me/R/ti/p/@'+oaIdNoAt(); return false;
  }
  function buildOrderSummary(items,total,name,email){
    const lines=['üõí ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà']; items.forEach(it=>lines.push(`‚Ä¢ ${it.name} x ${it.quantity} = ‡∏ø${it.price*it.quantity}`));
    lines.push(`‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø${total}`); if(name)lines.push(`‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á: ${name}`); if(email)lines.push(`‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${email}`); return lines.join('\n');
  }

  async function handleCheckout(){
    const customerName = el('customerName').value.trim();
    const customerEmail = el('customerEmail').value.trim();
    const statusMessage = el('checkout-status-message');
    const loadingIndicator = el('checkout-loading-indicator');
    const checkoutButton = el('checkout-button'); const closeBtn = el('cart-close-btn');

    try{ showLoading(); const latest=await apiGet({action:'getProducts'}); strains=latest.products||[]; equipments=latest.equipments||[]; } finally{ hideLoading(); }

    if(cart.length===0 || !customerName || !customerEmail){ statusMessage.textContent='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤'; statusMessage.className='text-center mt-4 text-sm text-red-500'; return; }

    loadingIndicator.classList.remove('hidden'); checkoutButton.disabled=true; closeBtn.disabled=true;
    statusMessage.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...'; statusMessage.className='text-center mt-4 text-sm text-blue-600';

    const totalAmount = cart.reduce((t,i)=>t+(i.price*i.quantity),0);
    const itemsForAPI = cart.map(i=>({ id:i.id, type:i.type, name:i.name, price:i.price, qty:i.quantity }));
    const u = getLineUser();
    const orderData = { action:'placeOrder', customerName, customerEmail, user_id:u.userId||'', email:customerEmail, items:itemsForAPI, total:totalAmount };

    try{
      const result = await apiPost(orderData);
      if(result.ok || result.status==='success'){
        const summary = buildOrderSummary(cart,totalAmount,customerName,customerEmail);
        cart=[]; updateCartUI(); statusMessage.textContent='‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏ï‡∏£‡πâ‡∏≤‡∏ô...';
        hideModal('cart-modal-container'); await sendOrderToOA(summary);
      }else{
        statusMessage.textContent='‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+(result.error||result.message||'‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ');
        statusMessage.className='text-center mt-4 text-sm text-red-500';
      }
    }catch(e){
      statusMessage.textContent='‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+(e.message||e); statusMessage.className='text-center mt-4 text-sm text-red-500';
    }finally{
      loadingIndicator.classList.add('hidden'); checkoutButton.disabled=false; closeBtn.disabled=false;
    }
  }

  async function initializeData(){
    showLoading();
    try{
      const r1=await apiGet({action:'getProducts'}); strains=r1.products||[]; equipments=r1.equipments||[];
      const r2=await apiGet({action:'getPromotions'}); promotions=r2.promotions||[]; toggleView(currentView);
    } finally { hideLoading(); }
  }

  // Drawer controls
  function openDrawer(){ const drawer=el('mobile-drawer'), panel=el('mobile-drawer-panel'); if(!drawer||!panel) return;
    drawer.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); requestAnimationFrame(()=> panel.classList.remove('translate-x-full')); }
  function closeDrawer(){ const drawer=el('mobile-drawer'), panel=el('mobile-drawer-panel'); if(!drawer||!panel) return;
    panel.classList.add('translate-x-full'); setTimeout(()=>{ drawer.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); },200); }

  // Boot
  document.addEventListener('DOMContentLoaded', ()=>{
    createFeelingButtons(); initializeData(); maybeInitLiff();

    el('cart-icon-container').addEventListener('click', ()=> showModal('cart-modal-container'));
    el('cart-close-btn').addEventListener('click', ()=> hideModal('cart-modal-container'));
    el('checkout-button').addEventListener('click', handleCheckout);
    el('modal-ok-btn').addEventListener('click', ()=> hideModal('modal-container'));
    el('line-login-btn').addEventListener('click', handleLineLogin);

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤" ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏•‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Ñ/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
    document.body.addEventListener('click', (e)=>{
      const t=e.target;
      if(t.classList.contains('add-to-cart-btn')) {
        openAddModal(t.dataset.id, t.dataset.type);
      }
      if(t.hasAttribute('data-qty')) changeQty(t.getAttribute('data-key'), t.getAttribute('data-qty')==='+1'?1:-1);
      if(t.hasAttribute('data-remove')) removeItem(t.getAttribute('data-key'));
    });

    // Drawer
    el('mobile-menu-btn')?.addEventListener('click', openDrawer);
    el('mobile-drawer-backdrop')?.addEventListener('click', closeDrawer);
    el('mobile-drawer-close')?.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeDrawer(); });

    const drawerRoot = el('mobile-drawer');
    drawerRoot && drawerRoot.addEventListener('click', (e)=>{
      const btn = e.target.closest('.drawer-link'); if(!btn) return;
      const action = btn.dataset.action;
      if(action==='go'){ toggleView(btn.dataset.target); }
      else if(action==='line-login'){ handleLineLogin(); }
      else if(action==='order-history'){
        try{ const u=getLineUser(); const url = u.userId ? ('profile.html?userId='+encodeURIComponent(u.userId)) : 'profile.html'; window.location.href=url; }
        catch{ showModal('modal-container','‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ','‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ'); }
      }
      closeDrawer();
    });

    // ====== bind ‡πÇ‡∏°‡∏î‡∏±‡∏•‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Ñ/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ======
    const qtyInput = el('qty-input');
    const unitPrice = el('unit-price');
    const totalPrice = el('total-price');

    el('qty-dec').addEventListener('click', ()=>{
      let v = Math.max(1, Number(qtyInput.value||1)-1);
      qtyInput.value = v;
      totalPrice.textContent = '‡∏ø'+(Number(unitPrice.textContent.replace('‡∏ø','')) * v);
    });
    el('qty-inc').addEventListener('click', ()=>{
      let v = Number(qtyInput.value||1)+1;
      if (addCtx.stock) v = Math.min(addCtx.stock, v);
      qtyInput.value = v;
      totalPrice.textContent = '‡∏ø'+(Number(unitPrice.textContent.replace('‡∏ø','')) * v);
    });
    qtyInput.addEventListener('input', ()=>{
      let v = Math.max(1, Number(qtyInput.value||1));
      if (addCtx.stock) v = Math.min(addCtx.stock, v);
      qtyInput.value = v;
      totalPrice.textContent = '‡∏ø'+(Number(unitPrice.textContent.replace('‡∏ø','')) * v);
    });

    el('add-cancel').addEventListener('click', ()=> hideModal('add-modal-container'));
    el('add-confirm').addEventListener('click', ()=>{
      const qty = Number(el('qty-input').value||1);
      // ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Ñ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      const checked = document.querySelector('#pack-options input[name="pack"]:checked');
      let packKey=null, packLabel=null, packPrice=null;
      if (checked){
        packKey = checked.value;
        const item = checked.closest('label');
        packLabel = item ? item.querySelector('span.flex-1')?.textContent : packKey;
        const ptext = item ? item.querySelector('span.font-semibold')?.textContent || '' : '';
        packPrice = Number((ptext.replace(/[^\d.]/g,''))||0);
      }
      addToCart(addCtx.id, addCtx.type, qty, packKey, packLabel, packPrice);
      hideModal('add-modal-container');
    });
  });
  </script>
</body>
</html>
