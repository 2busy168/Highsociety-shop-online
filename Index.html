<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H!GH$OC!‚Ç¨T¬• - Cannabis E-commerce</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Kanit', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #065f46 0%, #10b981 100%); }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,.1); }
    .feeling-btn { transition: all 0.2s ease; }
    .feeling-btn:hover { background-color: #d1fae5; transform: scale(1.05); }
    .feeling-btn.active { background-color: #047857; color: white; transform: scale(1.1);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); }
    .tag { padding: .25rem .75rem; border-radius: 9999px; font-size: .75rem; font-weight: 500; white-space: nowrap; }
    #loading-spinner { display: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <header class="gradient-bg text-white shadow-lg p-4 sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center px-4">
      <div class="text-2xl font-bold flex items-center cursor-pointer" onclick="window.location.reload();">
        <span class="mr-2">üå±</span>H!GH$OC!‚Ç¨T¬•
      </div>
      <nav class="hidden md:flex space-x-6 font-medium">
        <button id="strains-btn" class="hover:text-green-200 transition-colors" onclick="toggleView('strains')">‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</button>
        <button id="equipments-btn" class="hover:text-green-200 transition-colors" onclick="toggleView('equipments')">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
        <button id="promotions-btn" class="hover:text-green-200 transition-colors" onclick="toggleView('promotions')">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</button>
      </nav>
      <div class="flex items-center space-x-4">
        <a id="my-orders-link" href="profile.html" class="hidden text-white/90 hover:text-green-200 text-sm">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
        <button id="line-login-btn" class="bg-white text-green-600 font-semibold py-2 px-4 rounded-full text-sm hover:bg-gray-100 transition-colors">
          ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE
        </button>
        <a id="admin-login-btn" class="text-white hover:text-green-200 transition-colors text-sm" href="admin.html">
          Admin
        </a>
        <span class="relative cursor-pointer" id="cart-icon-container">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center">0</span>
        </span>
        <button id="mobile-menu-btn" class="md:hidden ml-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </header>

  <div id="loading-spinner" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-green-500"></div>
  </div>

  <section id="hero-section" class="gradient-bg text-white py-12 md:py-24 text-center px-4">
    <h1 id="hero-title" class="text-3xl md:text-5xl font-bold mb-4 animate-pulse">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì</h1>
    <p id="hero-subtitle" class="text-lg md:text-xl font-light mb-8">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì</p>
  </section>

  <section id="feelings-section" class="py-8 md:py-16 bg-white shadow-lg -mt-8 md:-mt-16 mx-auto rounded-xl max-w-7xl relative z-20">
    <h2 class="text-center text-xl md:text-2xl font-semibold mb-6 px-4">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô?</h2>
    <div id="feelings-container" class="flex flex-wrap justify-center gap-2 md:gap-4 px-4"></div>
  </section>

  <main class="container mx-auto py-8 md:py-12 px-4">
    <h2 id="main-content-title" class="text-2xl md:text-3xl font-bold text-center mb-6">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
    <div id="main-content-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
  </main>

  <footer class="bg-gray-800 text-white py-8 px-4">
    <div class="container mx-auto text-center">
      <h3 class="text-xl font-bold mb-2">H!GH$OC!‚Ç¨T¬•</h3>
      <p class="text-sm text-gray-400">‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏î‡∏µ ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏° ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£</p>
      <p class="text-xs text-gray-500 mt-4">‚ö†Ô∏è ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏ 20 ‡∏õ‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
    </div>
  </footer>

  <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full mx-4">
      <h3 id="modal-title" class="text-xl font-bold mb-4 text-center"></h3>
      <p id="modal-message" class="text-gray-700 text-center mb-6"></p>
      <div class="flex justify-center">
        <button id="modal-ok-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
    </div>
  </div>

  <div id="cart-modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full mx-4 overflow-y-auto max-h-[90vh]">
      <h3 class="text-2xl font-bold mb-4 text-center">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
      <div id="cart-items-list" class="space-y-4 mb-6"></div>
      <div id="cart-summary" class="border-t pt-4 text-right">
        <span class="text-lg font-bold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span id="cart-total-price">‡∏ø0</span></span>
      </div>
      <div id="order-form-container" class="mt-6">
        <h4 class="text-xl font-bold mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h4>
        <div class="mb-4">
          <label for="customerName" class="block text-gray-700 font-semibold mb-2">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <input type="text" id="customerName" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        <div class="mb-4">
          <label for="customerEmail" class="block text-gray-700 font-semibold mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
          <input type="email" id="customerEmail" placeholder="‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
      </div>
      <div class="relative mt-6">
        <button id="checkout-button" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all duration-300 transform hover:scale-105">
          ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        </button>
        <div id="checkout-loading-indicator" class="absolute inset-0 flex items-center justify-center bg-green-600 bg-opacity-75 rounded-xl hidden">
          <div class="w-8 h-8 border-4 border-white border-solid rounded-full animate-spin border-t-transparent"></div>
        </div>
      </div>
      <p id="checkout-status-message" class="text-center mt-4 text-sm text-gray-600"></p>
      <div class="flex justify-end mt-4">
        <button id="cart-close-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition-colors">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
  const APP_URL = "https://script.google.com/macros/s/AKfycbzis9Isw6XXUsi7k8MQmI4rJI8gnFnPS0VIDpuvsgw88dC8SwQ4VOHKK5TfeQMDKgLotA/exec";          // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß
  const LIFF_ID = "2007862659-qJLl52wb";   // TODO: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏° LIFF ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  const LINE_OA_ID = "761qogmt";

  const feelingToStrain = {
    "‡∏î‡∏π‡∏´‡∏ô‡∏±‡∏á":"Hybrid","‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á":"Hybrid","‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°":"Hybrid",
    "‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î":"Indica","‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤":"Indica","‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö":"Indica",
    "‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ò‡∏¥":"Sativa","‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÉ‡∏´‡∏°‡πà":"Sativa","‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ":"Sativa"
  };
  const strainDescriptions = {
    "Indica": { "icon":"üò¥", "tagColor":"bg-purple-100 text-purple-800" },
    "Sativa": { "icon":"‚ö°", "tagColor":"bg-yellow-100 text-yellow-800" },
    "Hybrid": { "icon":"üåø", "tagColor":"bg-green-100 text-green-800" }
  };
  const equipmentDescription = { icon:"‚öôÔ∏è", tagColor:"bg-gray-100 text-gray-800" };
  let strains=[], equipments=[], promotions=[], cart=[], currentView="strains", activeFeeling=null;

  const loadingSpinner = document.getElementById('loading-spinner');
  const mainContentList = document.getElementById('main-content-list');
  const mainContentTitle = document.getElementById('main-content-title');
  const feelingsSection = document.getElementById('feelings-section');
  const heroTitle = document.getElementById('hero-title');
  const heroSubtitle = document.getElementById('hero-subtitle');
  const lineLoginBtn = document.getElementById('line-login-btn');
  const myOrdersLink = document.getElementById('my-orders-link');

  function showLoading(){ loadingSpinner.style.display='flex'; }
  function hideLoading(){ loadingSpinner.style.display='none'; }
  function showModal(id,title='',message=''){
    const m=document.getElementById(id);
    if(id==='modal-container'){
      document.getElementById('modal-title').textContent=title;
      document.getElementById('modal-message').textContent=message;
    }
    m.classList.remove('hidden');
  }
  function hideModal(id){ document.getElementById(id).classList.add('hidden'); }
  function isStrainProduct(p){ return ['Indica','Sativa','Hybrid'].includes(String(p.type||'').trim()); }

  async function apiGet(params){
    const url=APP_URL+'?'+new URLSearchParams(params).toString();
    const res=await fetch(url,{cache:'no-store'}); return res.json();
  }
  async function apiPost(payload){
    const res=await fetch(APP_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    return res.json();
  }

  function updateHeroSection(title,subtitle){ heroTitle.textContent=title; heroSubtitle.textContent=subtitle; }
  function toggleView(view){
    currentView=view;
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('text-green-200'));
    const btn=document.getElementById(view+'-btn'); if(btn) btn.classList.add('text-green-200');
    if(view==='strains'){
      mainContentTitle.textContent='‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
      feelingsSection.style.display='block';
      updateHeroSection('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì','‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì');
      filterProductsByFeeling(activeFeeling);
    }else if(view==='equipments'){
      mainContentTitle.textContent='‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
      feelingsSection.style.display='none';
      updateHeroSection('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πà','‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
      renderContentCards(equipments,'equipments');
    }else if(view==='promotions'){
      mainContentTitle.textContent='‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©';
      feelingsSection.style.display='none';
      updateHeroSection('‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏∏‡∏î‡∏Ñ‡∏∏‡πâ‡∏°','‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏î‡∏µ‡πÜ ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà');
      renderContentCards(promotions,'promotions');
    }
  }

  function createFeelingButtons(){
    const wrap=document.getElementById('feelings-container'); wrap.innerHTML='';
    Object.keys(feelingToStrain).forEach(feeling=>{
      const st=feelingToStrain[feeling]; const info=strainDescriptions[st];
      const b=document.createElement('button');
      b.className='feeling-btn bg-green-50 text-gray-800 font-semibold py-2 px-4 rounded-full flex items-center shadow-sm hover:shadow-md';
      b.dataset.feeling=feeling;
      b.innerHTML='<span class="mr-2 text-lg">'+info.icon+'</span>'+feeling;
      b.addEventListener('click',handleFeelingClick);
      wrap.appendChild(b);
    });
  }
  function handleFeelingClick(e){
    document.querySelectorAll('.feeling-btn').forEach(b=>b.classList.remove('active'));
    const feeling=e.currentTarget.dataset.feeling;
    if(activeFeeling===feeling) activeFeeling=null; else { activeFeeling=feeling; e.currentTarget.classList.add('active'); }
    filterProductsByFeeling(activeFeeling);
  }
  function filterProductsByFeeling(feeling){
    let filtered=strains||[];
    if(feeling){
      const required=feelingToStrain[feeling];
      filtered=strains.filter(s=>String(s.type)===required);
      const info=strainDescriptions[required];
      mainContentTitle.innerHTML=info.icon+' ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <span class="text-green-600">"'+feeling+'"</span>';
    }else mainContentTitle.textContent='‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    renderContentCards(filtered,'strains');
  }

  function renderContentCards(items,type){
    mainContentList.innerHTML='';
    if(!items||!items.length){
      mainContentList.innerHTML='<p class="col-span-full text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ</p>';
      return;
    }
    items.forEach(it=>{ const card=(type==='promotions')?createPromotionCard(it):createProductCard(it); if(card) mainContentList.appendChild(card); });
  }
  function createProductCard(p){
    const info=isStrainProduct(p)?strainDescriptions[p.type]:equipmentDescription;
    const out=Number(p.stock||0)<=0;
    const stock= out?'<span class="text-red-500 font-semibold">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</span>' : '<span class="text-gray-500">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ '+p.stock+' ‡∏ä‡∏¥‡πâ‡∏ô</span>';
    const btn= out?'<button class="bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg cursor-not-allowed" disabled>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</button>'
                  :'<button class="add-to-cart-btn bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors" data-id="'+p.id+'" data-type="'+(isStrainProduct(p)?'strains':'equipments')+'">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>';
    const d=document.createElement('div');
    d.className='bg-white rounded-lg shadow-md p-6 card-hover flex flex-col justify-between';
    d.innerHTML = ''
      + '<div>'
      +   '<img src="'+(p.imageUrl||'')+'" onerror="this.onerror=null;this.src=\'https://placehold.co/400x300/cccccc/333333?text=Image+Not+Found\';" alt="'+(p.name||'')+'" class="rounded-md mb-4 object-cover w-full h-48">'
      +   '<div class="flex justify-between items-center mb-2">'
      +     '<h3 class="text-xl font-bold text-green-700">'+(p.name||'-')+'</h3>'
      +     '<div class="tag '+info.tagColor+' flex items-center"><span class="mr-1">'+info.icon+'</span><span>'+(p.type||'')+'</span></div>'
      +   '</div>'
      +   '<p class="text-sm text-gray-500 mb-4">'+(p.description||'')+'</p>'
      + '</div>'
      + '<div class="flex justify-between items-end mt-4">'
      +   '<div><span class="text-2xl font-bold text-gray-900">‡∏ø'+Number(p.price||0)+'</span> '+stock+'</div>'
      +   btn
      + '</div>';
    return d;
  }
  function createPromotionCard(pm){
    const d=document.createElement('div');
    d.className='bg-white rounded-lg shadow-md p-6 card-hover flex flex-col justify-between';
    const end=pm.endDate?new Date(pm.endDate):null;
    d.innerHTML = ''
      + '<div>'
      +   '<img src="'+(pm.imageUrl||'')+'" onerror="this.onerror=null;this.src=\'https://placehold.co/400x300/cccccc/333333?text=Image+Not+Found\';" alt="'+(pm.title||'')+'" class="rounded-md mb-4 object-cover w-full h-48">'
      +   '<h3 class="text-xl font-bold text-green-700 mb-2">'+(pm.title||'-')+'</h3>'
      +   '<p class="text-sm text-gray-500 mb-4">'+(pm.description||'')+'</p>'
      + '</div>'
      + '<div class="flex items-center space-x-2 text-sm text-gray-600 mt-4">'
      +   (pm.discount?'<span class="tag bg-red-100 text-red-800 font-semibold">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î '+pm.discount+'%</span>':'')
      +   (end?'<span class="tag bg-gray-100 text-gray-800">‡∏ñ‡∏∂‡∏á '+end.toLocaleDateString('th-TH')+'</span>':'')
      + '</div>';
    return d;
  }

  function getProductById(id,type){ const pool=(type==='strains')?strains:equipments; return pool.find(x=>String(x.id)===String(id)); }
  function addToCart(id,type){
    const p=getProductById(id,type); if(!p) return;
    const key=type+':'+p.id; const ex=cart.find(i=>i.key===key);
    if(Number(p.stock||0)<=0){ showModal('modal-container','‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î','"'+p.name+'" ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å'); return; }
    if(ex){ if(ex.quantity<Number(p.stock||0)) ex.quantity++; else return showModal('modal-container','‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠','"'+p.name+'" ‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å'); }
    else { cart.push({key,type,id:p.id,name:p.name,price:Number(p.price||0),quantity:1,imageUrl:p.imageUrl||''}); }
    updateCartUI(); showModal('modal-container','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡πÄ‡∏û‡∏¥‡πà‡∏° "'+p.name+'" ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
  }
  function updateCartUI(){
    const c=cart.reduce((t,i)=>t+i.quantity,0);
    document.getElementById('cart-count').textContent=c;
    renderCartItems();
  }
  function renderCartItems(){
    const list=document.getElementById('cart-items-list'); const btn=document.getElementById('checkout-button');
    list.innerHTML=''; let total=0;
    if(!cart.length){
      list.innerHTML='<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>';
      btn.disabled=true; btn.classList.add('bg-gray-400','cursor-not-allowed'); btn.classList.remove('bg-green-600','hover:bg-green-700');
    }else{
      cart.forEach(i=>{
        const line=i.price*i.quantity; total+=line;
        list.innerHTML += ''
          + '<div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">'
          +   '<div class="flex items-center space-x-4">'
          +     '<img src="'+i.imageUrl+'" alt="'+i.name+'" class="w-16 h-16 object-cover rounded-md">'
          +     '<div><h4 class="font-semibold">'+i.name+'</h4><p class="text-sm text-gray-500">‡∏ø'+i.price+' x '+i.quantity+'</p></div>'
          +   '</div>'
          +   '<div class="flex items-center gap-2">'
          +     '<button class="px-2 py-1 border rounded" data-qty="-1" data-key="'+i.key+'">-</button>'
          +     '<span class="font-bold">‡∏ø'+line+'</span>'
          +     '<button class="px-2 py-1 border rounded" data-qty="+1" data-key="'+i.key+'">+</button>'
          +     '<button class="px-2 py-1 border rounded text-red-600" data-remove="1" data-key="'+i.key+'">‡∏•‡∏ö</button>'
          +   '</div>'
          + '</div>';
      });
      btn.disabled=false; btn.classList.remove('bg-gray-400','cursor-not-allowed'); btn.classList.add('bg-green-600','hover:bg-green-700');
    }
    document.getElementById('cart-total-price').textContent='‡∏ø'+total;
  }
  function changeQty(key,delta){ const it=cart.find(i=>i.key===key); if(!it) return; it.quantity=Math.max(1,it.quantity+delta); updateCartUI(); }
  function removeItem(key){ cart=cart.filter(i=>i.key!==key); updateCartUI(); }

  async function handleCheckout(){
    const name=document.getElementById('customerName').value.trim();
    const email=document.getElementById('customerEmail').value.trim();
    const msg=document.getElementById('checkout-status-message');
    const loader=document.getElementById('checkout-loading-indicator');
    const btn=document.getElementById('checkout-button');
    const closeBtn=document.getElementById('cart-close-btn');
    const u=getLineUser();
    if(!cart.length||!name||!email){ msg.textContent='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤'; msg.className='text-center mt-4 text-sm text-red-500'; return; }
    try{ showLoading(); const r=await apiGet({action:'getProducts'}); strains=r.products||[]; equipments=r.equipments||[]; }finally{ hideLoading(); }
    loader.classList.remove('hidden'); btn.disabled=true; closeBtn.disabled=true; msg.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...'; msg.className='text-center mt-4 text-sm text-blue-600';
    const items=cart.map(i=>({id:i.id,name:i.name,price:i.price,qty:i.quantity}));
    const total=cart.reduce((s,i)=>s+i.price*i.quantity,0);
    try{
      const res=await apiPost({action:'placeOrder',user_id:u.userId||'',email,items,total});
      if(res.ok){
        msg.textContent='‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: '+res.order_id; msg.className='text-center mt-4 text-sm text-green-600';
        cart=[]; updateCartUI(); setTimeout(()=>hideModal('cart-modal-container'),1200);
        setTimeout(()=>{ window.location.href='https://line.me/R/ti/p/@'+LINE_OA_ID; },1500);
      }else{ msg.textContent='‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+(res.error||'‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ'); msg.className='text-center mt-4 text-sm text-red-500'; }
    }catch(e){ msg.textContent='‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+(e.message||e); msg.className='text-center mt-4 text-sm text-red-500'; }
    finally{ loader.classList.add('hidden'); btn.disabled=false; closeBtn.disabled=false; }
  }

  async function initLiff(){
    try{
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      const profile=await liff.getProfile();
      const u={ userId: profile.userId, displayName: profile.displayName, pictureUrl: profile.pictureUrl };
      localStorage.setItem('lineUser', JSON.stringify(u));
      paintUser(u);
    }catch(err){ console.warn('LIFF init error', err); }
  }
  function maybeInitLiff(){ if(!LIFF_ID || LIFF_ID.startsWith('PASTE_')) return; initLiff(); }
  function getLineUser(){ try{ return JSON.parse(localStorage.getItem('lineUser')||'{}'); }catch{ return {}; } }
  function paintUser(u){
    if(u && u.userId){
      lineLoginBtn.textContent='‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, '+(u.displayName||'‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô');
      myOrdersLink.href='profile.html?userId='+encodeURIComponent(u.userId);
      myOrdersLink.classList.remove('hidden');
    }
  }

  async function initializeData(){
    showLoading();
    try{
      const r1=await apiGet({action:'getProducts'}); strains=r1.products||[]; equipments=r1.equipments||[];
      const r2=await apiGet({action:'getPromotions'}); promotions=r2.promotions||[];
      toggleView(currentView);
    } finally { hideLoading(); }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    createFeelingButtons(); initializeData(); maybeInitLiff();
    document.getElementById('cart-icon-container').addEventListener('click', ()=> showModal('cart-modal-container'));
    document.getElementById('cart-close-btn').addEventListener('click', ()=> hideModal('cart-modal-container'));
    document.getElementById('checkout-button').addEventListener('click', handleCheckout);
    document.getElementById('modal-ok-btn').addEventListener('click', ()=> hideModal('modal-container'));
    document.body.addEventListener('click', (e)=>{
      const t=e.target;
      if (t.classList.contains('add-to-cart-btn')) addToCart(t.dataset.id, t.dataset.type);
      if (t.hasAttribute('data-qty')) changeQty(t.getAttribute('data-key'), t.getAttribute('data-qty')==='+1'?1:-1);
      if (t.hasAttribute('data-remove')) removeItem(t.getAttribute('data-key'));
    });
  });
  </script>
</body>
</html>
