<body class="p-6 text-gray-800">
  <h1 class="text-2xl font-bold mb-4">üõí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</h1>

  <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

  <button id="submit-order" class="bg-green-600 text-white py-2 px-4 rounded">
    ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ú‡πà‡∏≤‡∏ô LINE
  </button>

  <script>
    const sheetURL = 'https://script.google.com/macros/s/AKfycbwuCr0gtLosLfZ7v_fGrJlheswCuiznEAH2C81wgZFPp1PQ3rBgdO0Al-13CidUHUzjQQ/exec';

    let products = [];
    const selected = {};
    const listEl = document.getElementById("product-list");
    const btn = document.getElementById("submit-order");

    async function fetchProducts() {
      try {
        const res = await fetch(sheetURL + '?action=getProducts');
        const data = await res.json();
        products = [...(data.strains || []), ...(data.equipments || [])];
        renderProducts();
      } catch (err) {
        listEl.innerHTML = `<p class="text-red-500">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${err.message}</p>`;
      }
    }

    function renderProducts() {
      listEl.innerHTML = "";
      products.forEach(p => {
        const div = document.createElement("div");
        div.className = "border p-4 bg-white rounded shadow";
        div.innerHTML = `
          <h2 class="font-semibold text-lg mb-2">${p.name}</h2>
          <p>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${p.type}</p>
          <p>‡∏£‡∏≤‡∏Ñ‡∏≤: ${p.price} ‡∏ö‡∏≤‡∏ó</p>
          <p class="text-sm text-gray-600 mb-2">${p.desc}</p>
          <input type="number" min="0" value="0" id="qty-${p.name}" class="w-20 border px-2 py-1 rounded" />
        `;
        listEl.appendChild(div);
      });
    }

    function buildOrderSummary() {
      let total = 0;
      let text = `üßæ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠\n------------------------\n`;
      products.forEach(p => {
        const qty = parseInt(document.getElementById(`qty-${p.name}`).value);
        if (qty > 0) {
          const subtotal = qty * parseFloat(p.price);
          total += subtotal;
          text += `‚Ä¢ ${p.name} x ${qty} = ${subtotal}‡∏ø\n`;
        }
      });
      const discount = total >= 1000 ? 100 : 0;
      const final = total - discount;
      if (discount > 0) {
        text += `\nüîª ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: -${discount}‡∏ø`;
      }
      text += `\nüíµ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: ${final}‡∏ø`;
      text += `\n\n‡∏Ñ‡∏¥‡∏î‡∏à‡∏∞‡πÄ‡∏°‡∏≤ ‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏£‡∏≤ H!GH$OC!‚Ç¨T¬•`;
      return encodeURIComponent(text);
    }

    btn.addEventListener("click", () => {
      const message = buildOrderSummary();
      const lineURL = `https://line.me/R/oaMessage/@761qogmt/?${message}`;
      window.open(lineURL, '_blank');
    });

    fetchProducts();
  </script>
</body>
