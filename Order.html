<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>H!GH$OC!‚Ç¨T¬• - Weed Shop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Kanit', sans-serif;
      background: #f0fdf4;
    }
  </style>
</head>
<body class="p-6 text-gray-800">
  <h1 class="text-2xl font-bold mb-4">üõí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</h1>
  <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

  <button id="submit-order" class="bg-green-600 text-white py-2 px-4 rounded">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ú‡πà‡∏≤‡∏ô LINE</button>

  <script>
    const sheetURL = 'https://script.google.com/macros/s/AKfycbwuCr0gtLosLfZ7v_fGrJlheswCuiznEAH2C81wgZFPp1PQ3rBgdO0Al-13CidUHUzjQQ/exec';

    let products = [];
    const listEl = document.getElementById("product-list");
    const btn = document.getElementById("submit-order");

    async function fetchProducts() {
      const res = await fetch(sheetURL);
      const data = await res.json();
      products = data.products || data.strains || [];
      renderProducts();
    }

    function renderProducts() {
      listEl.innerHTML = "";
      products.forEach(p => {
        const div = document.createElement("div");
        div.className = "border p-4 bg-white rounded shadow";
        div.innerHTML = `
          <h2 class="font-semibold text-lg mb-2">${p.name}</h2>
          <p>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${p.type}</p>
          <p>‡∏£‡∏≤‡∏Ñ‡∏≤: ${p.price} ‡∏ö‡∏≤‡∏ó</p>
          <p class="text-sm text-gray-600 mb-2">${p.desc}</p>
          <input type="number" min="0" value="0" id="qty-${p.name}" class="w-20 border px-2 py-1 rounded" />
        `;
        listEl.appendChild(div);
      });
    }

    function buildOrderSummary() {
      let total = 0;
      let orderText = `üßæ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠\n------------------------\n`;
      const orderData = [];

      products.forEach(p => {
        const qty = parseInt(document.getElementById(`qty-${p.name}`).value);
        if (qty > 0) {
          const subtotal = qty * parseFloat(p.price);
          total += subtotal;
          orderText += `‚Ä¢ ${p.name} x ${qty} = ${subtotal}‡∏ø\n`;
          orderData.push({ name: p.name, qty, subtotal });
        }
      });

      const discount = total >= 1000 ? 100 : 0;
      const final = total - discount;
      if (discount > 0) {
        orderText += `\nüîª ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: -${discount}‡∏ø`;
      }
      orderText += `\nüíµ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: ${final}‡∏ø`;
      orderText += `\n\n‡∏Ñ‡∏¥‡∏î‡∏à‡∏∞‡πÄ‡∏°‡∏≤ ‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏£‡∏≤ H!GH$OC!‚Ç¨T¬•`;

      // ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheet
      fetch(sheetURL, {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: "processOrder",
          orderItems: orderData,
          totalAmount: final,
          customerName: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å LINE",
          customerEmail: "",
          userId: ""
        })
      });

      return encodeURIComponent(orderText);
    }

    btn.addEventListener("click", () => {
      const message = buildOrderSummary();
      const lineURL = `https://line.me/R/oaMessage/@761qogmt/?${message}`;
      window.open(lineURL, '_blank');
    });

    fetchProducts();
  </script>
</body>
</html>
