<script>
const sheetURL = 'https://script.google.com/macros/s/AKfycbwuCr0gtLosLfZ7v_fGrJlheswCuiznEAH2C81wgZFPp1PQ3rBgdO0Al-13CidUHUzjQQ/exec';

let products = [];
const selected = {};
const listEl = document.getElementById("product-list");
const btn = document.getElementById("submit-order");

async function fetchProducts() {
  try {
    const res = await fetch(sheetURL + '?action=getProducts');
    const data = await res.json();
    products = [...(data.strains || []), ...(data.equipments || [])];
    renderProducts();
  } catch (err) {
    listEl.innerHTML = `<p class="text-red-500">à¹‚à¸«à¸¥à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§: ${err.message}</p>`;
  }
}

function renderProducts() {
  listEl.innerHTML = "";
  products.forEach(p => {
    const div = document.createElement("div");
    div.className = "border p-4 bg-white rounded shadow";
    div.innerHTML = `
      <h2 class="font-semibold text-lg mb-2">${p.name}</h2>
      <p>à¸›à¸£à¸°à¹€à¸ à¸—: ${p.type}</p>
      <p>à¸£à¸²à¸„à¸²: ${p.price} à¸šà¸²à¸—</p>
      <p class="text-sm text-gray-600 mb-2">${p.desc}</p>
      <input type="number" min="0" value="0" id="qty-${p.name}" class="w-20 border px-2 py-1 rounded" />
    `;
    listEl.appendChild(div);
  });
}

function buildOrderSummary() {
  let total = 0;
  let text = `ðŸ§¾ à¸£à¸²à¸¢à¸à¸²à¸£à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­\n------------------------\n`;
  products.forEach(p => {
    const qty = parseInt(document.getElementById(`qty-${p.name}`).value);
    if (qty > 0) {
      const subtotal = qty * parseFloat(p.price);
      total += subtotal;
      text += `â€¢ ${p.name} x ${qty} = ${subtotal}à¸¿\n`;
    }
  });
  const discount = total >= 1000 ? 100 : 0;
  const final = total - discount;
  if (discount > 0) {
    text += `\nðŸ”» à¸ªà¹ˆà¸§à¸™à¸¥à¸”: -${discount}à¸¿`;
  }
  text += `\nðŸ’µ à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸ªà¸´à¹‰à¸™: ${final}à¸¿`;
  text += `\n\nà¸„à¸´à¸”à¸ˆà¸°à¹€à¸¡à¸² à¸„à¸´à¸”à¸–à¸¶à¸‡à¹€à¸£à¸² H!GH$OC!â‚¬TÂ¥`;
  return encodeURIComponent(text);
}

btn.addEventListener("click", () => {
  const message = buildOrderSummary();
  const lineURL = `https://line.me/R/oaMessage/@761qogmt/?${message}`;
  window.open(lineURL, '_blank');
});

fetchProducts();
</script>
